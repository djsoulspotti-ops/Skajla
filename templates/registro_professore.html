<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìù Registro Elettronico - SKAILA</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #00d4ff;
            --secondary: #7c3aed;
            --accent: #ff006e;
            --success: #00ff88;
            --warning: #ffaa00;
            --error: #ff0066;
            --dark: #0a0a0f;
            --darker: #050508;
            --light: #1a1a2e;
            --text: #ffffff;
            --border: rgba(0, 212, 255, 0.2);
            --gradient-primary: linear-gradient(135deg, #00d4ff 0%, #7c3aed 50%, #ff006e 100%);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--darker);
            color: var(--text);
        }

.registro-dashboard {
    background: var(--darker);
    min-height: 100vh;
    padding: 2rem;
}

.registro-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    background: var(--light);
    padding: 0.5rem;
    border-radius: 15px;
}

.tab-btn {
    flex: 1;
    padding: 1rem;
    border: none;
    background: transparent;
    color: var(--text-light);
    font-weight: 600;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.tab-btn.active {
    background: var(--gradient-primary);
    color: white;
}

.tab-btn:hover {
    background: rgba(0, 212, 255, 0.1);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Presenze */
.presenze-container {
    background: var(--light);
    border-radius: 15px;
    padding: 2rem;
}

.class-selector {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    align-items: center;
}

.class-selector select {
    padding: 0.8rem;
    border-radius: 8px;
    border: 2px solid var(--border);
    background: var(--darker);
    color: var(--text);
    font-size: 1rem;
}

.presenze-table {
    width: 100%;
    border-collapse: collapse;
}

.presenze-table thead {
    background: var(--darker);
}

.presenze-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--primary);
}

.presenze-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--border);
}

.presenze-table tr:hover {
    background: rgba(0, 212, 255, 0.05);
}

.status-selector {
    display: flex;
    gap: 0.5rem;
}

.status-btn {
    padding: 0.5rem 1rem;
    border: 2px solid var(--border);
    background: var(--darker);
    color: var(--text);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.85rem;
}

.status-btn.present {
    border-color: var(--success);
    background: var(--success);
    color: var(--dark);
}

.status-btn.absent {
    border-color: var(--error);
    background: var(--error);
    color: white;
}

.status-btn.late {
    border-color: var(--warning);
    background: var(--warning);
    color: var(--dark);
}

.status-btn.early {
    border-color: var(--primary);
    background: var(--primary);
    color: var(--dark);
}

.save-presenze-btn {
    background: var(--gradient-primary);
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 1.5rem;
    width: 100%;
    font-size: 1.1rem;
    transition: transform 0.3s ease;
}

.save-presenze-btn:hover {
    transform: translateY(-2px);
}

/* Voti */
.voti-container {
    background: var(--light);
    border-radius: 15px;
    padding: 2rem;
}

.voto-form {
    background: var(--darker);
    padding: 1.5rem;
    border-radius: 10px;
    margin-bottom: 2rem;
    border-left: 4px solid var(--primary);
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-group label {
    font-weight: 600;
    font-size: 0.9rem;
}

.form-group input, .form-group select {
    padding: 0.8rem;
    border: 2px solid var(--border);
    border-radius: 8px;
    background: var(--light);
    color: var(--text);
    font-size: 1rem;
}

.form-group input:focus, .form-group select:focus {
    outline: none;
    border-color: var(--primary);
}

.voti-list {
    max-height: 400px;
    overflow-y: auto;
}

.voto-card {
    background: var(--darker);
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 0.8rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-left: 4px solid var(--success);
}

.voto-card.low {
    border-color: var(--error);
}

.voto-card.medium {
    border-color: var(--warning);
}

.voto-info {
    flex: 1;
}

.voto-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary);
}

/* Note Disciplinari */
.note-container {
    background: var(--light);
    border-radius: 15px;
    padding: 2rem;
}

.severity-selector {
    display: flex;
    gap: 0.5rem;
    margin: 1rem 0;
}

.severity-btn {
    padding: 0.6rem 1.2rem;
    border: 2px solid var(--border);
    background: var(--darker);
    color: var(--text);
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.severity-btn.active.lieve {
    background: var(--warning);
    border-color: var(--warning);
    color: var(--dark);
}

.severity-btn.active.media {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
}

.severity-btn.active.grave {
    background: var(--error);
    border-color: var(--error);
    color: white;
}

.note-list {
    margin-top: 2rem;
}

.nota-card {
    background: var(--darker);
    padding: 1.5rem;
    border-radius: 10px;
    margin-bottom: 1rem;
}

.nota-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.severity-badge {
    padding: 0.4rem 1rem;
    border-radius: 15px;
    font-weight: 600;
    font-size: 0.9rem;
}

.severity-badge.lieve {
    background: var(--warning);
    color: var(--dark);
}

.severity-badge.media {
    background: var(--accent);
    color: white;
}

.severity-badge.grave {
    background: var(--error);
    color: white;
}

/* Calendario Lezioni */
.calendario-container {
    background: var(--light);
    border-radius: 15px;
    padding: 2rem;
}

.lezione-card {
    background: var(--darker);
    padding: 1.5rem;
    border-radius: 10px;
    margin-bottom: 1rem;
    border-left: 4px solid var(--primary);
}

.lezione-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.lezione-date {
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--primary);
}

.lezione-topic {
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
}

.lezione-homework {
    background: rgba(0, 212, 255, 0.1);
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
    border-left: 3px solid var(--primary);
}

.quick-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-box {
    background: var(--darker);
    padding: 1.5rem;
    border-radius: 10px;
    text-align: center;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.stat-label {
    color: var(--text-light);
    font-size: 0.9rem;
    margin-top: 0.5rem;
}
</style>

<div class="registro-dashboard">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1>üìù Registro Elettronico</h1>
        <a href="/dashboard" style="padding: 0.75rem 1.5rem; background: rgba(255,255,255,0.1); border-radius: 10px; color: white; text-decoration: none; font-weight: 600;">
            <i class="fas fa-arrow-left"></i> Dashboard
        </a>
    </div>

    <!-- Tabs -->
    <div class="registro-tabs">
        <button class="tab-btn active" onclick="switchTab('presenze')">üìã Presenze</button>
        <button class="tab-btn" onclick="switchTab('voti')">üìä Voti</button>
        <button class="tab-btn" onclick="switchTab('note')">‚ö†Ô∏è Note Disciplinari</button>
        <button class="tab-btn" onclick="switchTab('calendario')">üìÖ Calendario</button>
    </div>

    <!-- PRESENZE TAB -->
    <div id="presenzeTab" class="tab-content active">
        <div class="presenze-container">
            <div class="class-selector">
                <label style="font-weight: 600;">Classe:</label>
                <select id="classePresenze" onchange="loadPresenze()">
                    <option value="">Seleziona classe</option>
                    {% if user.classe %}
                    <option value="{{ user.classe }}" selected>{{ user.classe }}</option>
                    {% else %}
                    <option value="1A">1A</option>
                    <option value="2A">2A</option>
                    <option value="3A">3A</option>
                    <option value="4A">4A</option>
                    <option value="5A">5A</option>
                    {% endif %}
                </select>
                <input type="date" id="dataPresenze" onchange="loadPresenze()" style="padding: 0.8rem; border-radius: 8px; border: 2px solid var(--border); background: var(--darker); color: var(--text);">
            </div>

            <div id="presenzeContent">
                <table class="presenze-table">
                    <thead>
                        <tr>
                            <th>Studente</th>
                            <th>Stato</th>
                            <th>Note</th>
                        </tr>
                    </thead>
                    <tbody id="presenzeTableBody">
                        <tr><td colspan="3" style="text-align: center; padding: 2rem; color: var(--text-light);">Seleziona una classe</td></tr>
                    </tbody>
                </table>

                <button class="save-presenze-btn" onclick="savePresenze()">
                    üíæ Salva Presenze
                </button>
            </div>
        </div>
    </div>

    <!-- VOTI TAB -->
    <div id="votiTab" class="tab-content">
        <div class="voti-container">
            <div class="voto-form">
                <h3 style="margin-bottom: 1.5rem;">Inserisci Nuovo Voto</h3>
                <form id="votoForm" onsubmit="addVoto(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Studente *</label>
                            <select id="votoStudente" required>
                                <option value="">Seleziona studente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Materia *</label>
                            <select id="votoMateria" required>
                                <option value="matematica">Matematica</option>
                                <option value="italiano">Italiano</option>
                                <option value="storia">Storia</option>
                                <option value="scienze">Scienze</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Voto (1-10) *</label>
                            <input type="number" id="votoValore" min="1" max="10" step="0.5" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo *</label>
                            <select id="votoTipo" required>
                                <option value="scritto">Scritto</option>
                                <option value="orale">Orale</option>
                                <option value="pratico">Pratico</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Descrizione</label>
                            <input type="text" id="votoDescrizione" placeholder="Es: Verifica equazioni">
                        </div>
                    </div>
                    <button type="submit" class="save-presenze-btn">
                        ‚ûï Aggiungi Voto
                    </button>
                </form>
            </div>

            <h3 style="margin: 2rem 0 1rem;">Voti Recenti</h3>
            <div class="voti-list" id="votiList">
                <div style="text-align: center; padding: 2rem; color: var(--text-light);">Nessun voto inserito</div>
            </div>
        </div>
    </div>

    <!-- NOTE TAB -->
    <div id="noteTab" class="tab-content">
        <div class="note-container">
            <div class="voto-form">
                <h3 style="margin-bottom: 1.5rem;">Nuova Nota Disciplinare</h3>
                <form id="notaForm" onsubmit="addNota(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Studente *</label>
                            <select id="notaStudente" required>
                                <option value="">Seleziona studente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tipo *</label>
                            <select id="notaTipo" required>
                                <option value="comportamento">Comportamento</option>
                                <option value="ritardo">Ritardo</option>
                                <option value="compiti">Compiti non svolti</option>
                                <option value="altro">Altro</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Gravit√† *</label>
                        <div class="severity-selector">
                            <button type="button" class="severity-btn active lieve" onclick="selectSeverity('lieve')">Lieve</button>
                            <button type="button" class="severity-btn media" onclick="selectSeverity('media')">Media</button>
                            <button type="button" class="severity-btn grave" onclick="selectSeverity('grave')">Grave</button>
                        </div>
                        <input type="hidden" id="notaGravita" value="lieve">
                    </div>
                    
                    <div class="form-group">
                        <label>Descrizione *</label>
                        <textarea id="notaDescrizione" rows="3" required style="width: 100%; padding: 0.8rem; border: 2px solid var(--border); border-radius: 8px; background: var(--light); color: var(--text); font-family: inherit;"></textarea>
                    </div>
                    
                    <button type="submit" class="save-presenze-btn">
                        ‚ö†Ô∏è Inserisci Nota
                    </button>
                </form>
            </div>

            <div class="note-list" id="noteList">
                <div style="text-align: center; padding: 2rem; color: var(--text-light);">Nessuna nota disciplinare</div>
            </div>
        </div>
    </div>

    <!-- CALENDARIO TAB -->
    <div id="calendarioTab" class="tab-content">
        <div class="calendario-container">
            <div class="voto-form">
                <h3 style="margin-bottom: 1.5rem;">Pianifica Lezione</h3>
                <form id="lezioneForm" onsubmit="addLezione(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Data *</label>
                            <input type="date" id="lezioneData" required>
                        </div>
                        <div class="form-group">
                            <label>Ora *</label>
                            <input type="time" id="lezioneOra" required>
                        </div>
                        <div class="form-group">
                            <label>Classe *</label>
                            <select id="lezioneClasse" required>
                                {% if user.classe %}
                                <option value="{{ user.classe }}" selected>{{ user.classe }}</option>
                                {% else %}
                                <option value="1A">1A</option>
                                <option value="2A">2A</option>
                                <option value="3A">3A</option>
                                <option value="4A">4A</option>
                                <option value="5A">5A</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Argomento *</label>
                        <input type="text" id="lezioneTopic" required placeholder="Es: Equazioni di secondo grado">
                    </div>
                    <div class="form-group">
                        <label>Compiti per casa</label>
                        <textarea id="lezioneHomework" rows="2" style="width: 100%; padding: 0.8rem; border: 2px solid var(--border); border-radius: 8px; background: var(--light); color: var(--text); font-family: inherit;" placeholder="Es: Esercizi pag. 45, n. 1-10"></textarea>
                    </div>
                    <button type="submit" class="save-presenze-btn">
                        üìÖ Aggiungi Lezione
                    </button>
                </form>
            </div>

            <h3 style="margin: 2rem 0 1rem;">Prossime Lezioni</h3>
            <div id="calendarioList">
                <div style="text-align: center; padding: 2rem; color: var(--text-light);">Nessuna lezione pianificata</div>
            </div>
        </div>
    </div>
</div>

<script>
let currentTab = 'presenze';
let presenzeData = {};
let selectedSeverity = 'lieve';
let studentiData = {{ studenti|tojson|safe }};

// Switch Tab
function switchTab(tab) {
    currentTab = tab;
    
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tab + 'Tab').classList.add('active');
    
    if (tab === 'presenze') loadPresenze();
    if (tab === 'voti') loadVoti();
    if (tab === 'note') loadNote();
    if (tab === 'calendario') loadCalendario();
}

// PRESENZE Functions
async function loadPresenze() {
    const classe = document.getElementById('classePresenze').value;
    const data = document.getElementById('dataPresenze').value;
    
    if (!classe) return;
    
    const tbody = document.getElementById('presenzeTableBody');
    
    if (!studentiData || studentiData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 2rem;">Nessuno studente trovato in questa classe</td></tr>';
        return;
    }
    
    tbody.innerHTML = studentiData.map(student => `
        <tr data-student-id="${student.id}">
            <td><strong>${student.nome} ${student.cognome}</strong></td>
            <td>
                <div class="status-selector">
                    <button type="button" class="status-btn present" onclick="setStatus(${student.id}, 'presente')">‚úÖ Presente</button>
                    <button type="button" class="status-btn" onclick="setStatus(${student.id}, 'assente')">‚ùå Assente</button>
                    <button type="button" class="status-btn" onclick="setStatus(${student.id}, 'ritardo')">‚è∞ Ritardo</button>
                    <button type="button" class="status-btn" onclick="setStatus(${student.id}, 'uscita_anticipata')">üö™ Uscita</button>
                </div>
            </td>
            <td><input type="text" id="note_${student.id}" placeholder="Note opzionali" style="padding: 0.5rem; background: var(--darker); border: 1px solid var(--border); border-radius: 5px; color: var(--text); width: 100%;"></td>
        </tr>
    `).join('');
    
    presenzeData = {};
    studentiData.forEach(s => presenzeData[s.id] = {status: 'presente', note: ''});
}

function setStatus(studentId, status) {
    if (!presenzeData[studentId]) {
        presenzeData[studentId] = {note: ''};
    }
    presenzeData[studentId].status = status;
    
    const row = document.querySelector(`tr[data-student-id="${studentId}"]`);
    if (row) {
        row.querySelectorAll('.status-btn').forEach(btn => {
            btn.className = 'status-btn';
        });
        event.target.classList.add(status);
    }
}

async function savePresenze() {
    const classe = document.getElementById('classePresenze').value;
    const data = document.getElementById('dataPresenze').value;
    
    if (!classe || !data) {
        alert('‚ö†Ô∏è Seleziona classe e data!');
        return;
    }
    
    // Raccogli note
    studentiData.forEach(s => {
        const noteInput = document.getElementById(`note_${s.id}`);
        if (noteInput && presenzeData[s.id]) {
            presenzeData[s.id].note = noteInput.value;
        }
    });
    
    // Costruisci payload per API
    const attendance_list = Object.entries(presenzeData).map(([studentId, data]) => ({
        student_id: parseInt(studentId),
        status: data.status,
        note: data.note || ''
    }));
    
    const payload = {
        classe: classe,
        date: data,
        attendance_list: attendance_list
    };
    
    try {
        const response = await fetch('/api/registro/presenze/classe', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(`‚úÖ Presenze salvate! ${result.marked} studenti registrati`);
        } else {
            alert(`‚ùå Errore: ${result.error || 'Errore sconosciuto'}`);
        }
    } catch (error) {
        console.error('Errore salvataggio presenze:', error);
        alert('‚ùå Errore di connessione al server');
    }
}

// VOTI Functions
async function addVoto(e) {
    e.preventDefault();
    
    const studentId = parseInt(document.getElementById('votoStudente').value);
    const materia = document.getElementById('votoMateria').value;
    const grade = parseFloat(document.getElementById('votoValore').value);
    const tipo = document.getElementById('votoTipo').value;
    const descrizione = document.getElementById('votoDescrizione').value;
    
    if (!studentId || !materia || !grade) {
        alert('‚ö†Ô∏è Compila tutti i campi obbligatori!');
        return;
    }
    
    const payload = {
        student_id: studentId,
        subject: materia,
        grade: grade,
        evaluation_type: tipo,
        description: descrizione,
        date: new Date().toISOString().split('T')[0]
    };
    
    try {
        const response = await fetch('/api/registro/voti/inserisci', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('‚úÖ Voto inserito con successo!');
            document.getElementById('votoForm').reset();
            loadVoti();
        } else {
            alert(`‚ùå Errore: ${result.error || 'Errore sconosciuto'}`);
        }
    } catch (error) {
        console.error('Errore inserimento voto:', error);
        alert('‚ùå Errore di connessione al server');
    }
}

function loadVoti() {
    // Simulate loading recent grades
    const voti = [
        { studente: 'Marco Rossi', materia: 'Matematica', valore: 8, tipo: 'scritto', data: '2025-12-10' },
        { studente: 'Giulia Bianchi', materia: 'Italiano', valore: 9, tipo: 'orale', data: '2025-12-09' }
    ];
    
    const list = document.getElementById('votiList');
    list.innerHTML = voti.map(v => `
        <div class="voto-card ${v.valore < 6 ? 'low' : v.valore < 7 ? 'medium' : ''}">
            <div class="voto-info">
                <strong>${v.studente}</strong> - ${v.materia}
                <div style="font-size: 0.9rem; color: var(--text-light); margin-top: 0.3rem;">
                    ${v.tipo} | ${v.data}
                </div>
            </div>
            <div class="voto-value">${v.valore}</div>
        </div>
    `).join('');
}

// NOTE Functions
function selectSeverity(severity) {
    selectedSeverity = severity;
    document.getElementById('notaGravita').value = severity;
    
    document.querySelectorAll('.severity-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

async function addNota(e) {
    e.preventDefault();
    
    const studentId = parseInt(document.getElementById('notaStudente').value);
    const descrizione = document.getElementById('notaDescrizione').value;
    
    if (!studentId || !descrizione) {
        alert('‚ö†Ô∏è Seleziona studente e inserisci descrizione!');
        return;
    }
    
    const payload = {
        student_id: studentId,
        description: descrizione,
        severity: selectedSeverity,
        date: new Date().toISOString().split('T')[0]
    };
    
    try {
        const response = await fetch('/api/registro/note/inserisci', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('‚ö†Ô∏è Nota disciplinare inserita!');
            document.getElementById('notaForm').reset();
            selectedSeverity = 'lieve';
            document.querySelectorAll('.severity-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.severity-btn.lieve').classList.add('active');
            loadNote();
        } else {
            alert(`‚ùå Errore: ${result.error || 'Errore sconosciuto'}`);
        }
    } catch (error) {
        console.error('Errore inserimento nota:', error);
        alert('‚ùå Errore di connessione al server');
    }
}

function loadNote() {
    const note = [
        { studente: 'Luca Verdi', tipo: 'comportamento', gravita: 'media', descrizione: 'Disturbo durante la lezione', data: '2025-12-11' }
    ];
    
    const list = document.getElementById('noteList');
    list.innerHTML = note.map(n => `
        <div class="nota-card">
            <div class="nota-header">
                <strong>${n.studente}</strong>
                <span class="severity-badge ${n.gravita}">${n.gravita.toUpperCase()}</span>
            </div>
            <div style="color: var(--text-light); margin-bottom: 0.5rem;">${n.tipo} | ${n.data}</div>
            <div>${n.descrizione}</div>
        </div>
    `).join('');
}

// CALENDARIO Functions
async function addLezione(e) {
    e.preventDefault();
    
    const classe = document.getElementById('lezioneClasse').value;
    const topic = document.getElementById('lezioneTopic').value;
    const data = document.getElementById('lezioneData').value;
    const homework = document.getElementById('lezioneHomework').value;
    
    if (!classe || !topic || !data) {
        alert('‚ö†Ô∏è Compila i campi obbligatori (data, classe, argomento)!');
        return;
    }
    
    const payload = {
        class: classe,
        subject: 'Generale',  // Potrebbe essere reso dinamico
        topic: topic,
        homework: homework || '',
        lesson_date: data
    };
    
    try {
        const response = await fetch('/api/registro/lezioni/aggiungi', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('üìÖ Lezione pianificata!');
            document.getElementById('lezioneForm').reset();
            loadCalendario();
        } else {
            alert(`‚ùå Errore: ${result.error || 'Errore sconosciuto'}`);
        }
    } catch (error) {
        console.error('Errore pianificazione lezione:', error);
        alert('‚ùå Errore di connessione al server');
    }
}

function loadCalendario() {
    const lezioni = [
        { data: '2025-12-15', ora: '09:00', classe: '3A', topic: 'Equazioni secondo grado', homework: 'Es. pag. 45' }
    ];
    
    const list = document.getElementById('calendarioList');
    list.innerHTML = lezioni.map(l => `
        <div class="lezione-card">
            <div class="lezione-header">
                <div>
                    <div class="lezione-date">${l.data} - ${l.ora}</div>
                    <div style="color: var(--text-light);">Classe: ${l.classe}</div>
                </div>
            </div>
            <div class="lezione-topic">${l.topic}</div>
            ${l.homework ? `
                <div class="lezione-homework">
                    <strong>üìù Compiti:</strong> ${l.homework}
                </div>
            ` : ''}
        </div>
    `).join('');
}

// Popola dropdown studenti
function populateStudentDropdowns() {
    const votoSelect = document.getElementById('votoStudente');
    const notaSelect = document.getElementById('notaStudente');
    
    if (!studentiData || studentiData.length === 0) {
        return;
    }
    
    studentiData.forEach(s => {
        const option1 = document.createElement('option');
        option1.value = s.id;
        option1.textContent = `${s.nome} ${s.cognome}`;
        votoSelect.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = s.id;
        option2.textContent = `${s.nome} ${s.cognome}`;
        notaSelect.appendChild(option2);
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('dataPresenze').valueAsDate = new Date();
    document.getElementById('lezioneData').valueAsDate = new Date();
    populateStudentDropdowns();
    
    // Imposta classe dal backend
    {% if user.classe %}
    document.getElementById('classePresenze').value = '{{ user.classe }}';
    document.getElementById('lezioneClasse').value = '{{ user.classe }}';
    loadPresenze();
    {% endif %}
});
</script>
</body>
</html>
