<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#003B73">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SKAILA">
    <title>Gamification - SKAILA</title>
    <link rel="manifest" href="/static/manifest.json">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="/static/css/tokens.css" rel="stylesheet">
    <link href="/static/css/dashboard-premium.css" rel="stylesheet">
    <link href="/static/css/mobile-first.css" rel="stylesheet">
    <link href="/static/css/gamification-v2.css" rel="stylesheet">
</head>
<body class="dashboard-page">
    <div class="dashboard-container" id="dashboardContainer">
        <aside class="dashboard-sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-brand">SKAILA</div>
                <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-label">Menu</div>
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a href="/dashboard" class="nav-link">
                                <span class="nav-icon"><i class="fas fa-home"></i></span>
                                <span class="nav-text">Dashboard</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/calendario" class="nav-link">
                                <span class="nav-icon"><i class="fas fa-calendar"></i></span>
                                <span class="nav-text">Calendario</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/registro" class="nav-link">
                                <span class="nav-icon"><i class="fas fa-book"></i></span>
                                <span class="nav-text">Registro</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/chat" class="nav-link">
                                <span class="nav-icon"><i class="fas fa-comments"></i></span>
                                <span class="nav-text">Messaggi</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="nav-section">
                    <div class="nav-section-label">Strumenti</div>
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a href="/ai-chat" class="nav-link">
                                <span class="nav-icon"><i class="fas fa-robot"></i></span>
                                <span class="nav-text">AI Coach</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/materiali" class="nav-link">
                                <span class="nav-icon"><i class="fas fa-folder"></i></span>
                                <span class="nav-text">Materiali</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/gamification" class="nav-link active">
                                <span class="nav-icon"><i class="fas fa-trophy"></i></span>
                                <span class="nav-text">Gamification</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/skaila-connect" class="nav-link">
                                <span class="nav-icon"><i class="fas fa-briefcase"></i></span>
                                <span class="nav-text">SKAILA Connect</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-profile-card">
                    <div class="user-avatar">
                        {{ user.nome[0] if user and user.nome else 'S' }}{{ user.cognome[0] if user and user.cognome else 'K' }}
                    </div>
                    <div class="user-details">
                        <div class="user-name">{{ user.nome }} {{ user.cognome }}</div>
                        <div class="user-role">{{ user.ruolo|capitalize if user else 'Studente' }}</div>
                    </div>
                </div>
                <a href="/logout" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Esci</span>
                </a>
            </div>
        </aside>

        <main class="dashboard-main">
            <div class="dashboard-header">
                <div class="header-left">
                    <h1 class="page-title">
                        <i class="fas fa-trophy" style="color: var(--color-gold-500);"></i>
                        Gamification
                    </h1>
                    <p class="page-subtitle">Guadagna XP, completa sfide e scala la classifica!</p>
                </div>
                <div class="header-right">
                    <div class="gami-header-stats">
                        <div class="header-stat-item">
                            <span class="stat-icon"><i class="fas fa-fire" style="color: var(--color-amber-500);"></i></span>
                            <span class="stat-value" id="headerStreak">{{ profile.streak_corrente or 0 }}</span>
                            <span class="stat-label">Streak</span>
                        </div>
                        <div class="header-stat-item">
                            <span class="stat-icon"><i class="fas fa-star" style="color: var(--color-gold-400);"></i></span>
                            <span class="stat-value" id="headerXP">{{ profile.xp_totale or 0 }}</span>
                            <span class="stat-label">XP Totali</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bento-grid hero-layout">
                <div class="gami-profile-card">
                    <div class="profile-rank-display">
                        <div class="rank-icon-large" id="rankIconLarge">
                            <span>{{ profile.rank_icon or 'üå±' }}</span>
                        </div>
                        <div class="rank-info">
                            <h2 class="rank-name">{{ profile.rango or 'Germoglio' }}</h2>
                            <p class="rank-subtitle">Livello {{ profile.livello or 1 }}</p>
                        </div>
                    </div>
                    
                    <div class="xp-progress-section">
                        <div class="xp-label-row">
                            <span class="xp-current">{{ profile.xp_totale or 0 }} XP</span>
                            <span class="xp-next">{{ profile.xp_prossimo_rango or 200 }} XP</span>
                        </div>
                        <div class="xp-progress-bar-v2">
                            <div class="xp-progress-fill-v2" id="xpProgressFill" style="width: {{ profile.progress_percentage or 0 }}%;"></div>
                        </div>
                        <p class="xp-remaining">{{ profile.xp_mancanti or 200 }} XP per {{ profile.prossimo_rango or 'Esploratore' }}</p>
                    </div>

                    <div class="profile-quick-stats">
                        <div class="quick-stat">
                            <i class="fas fa-calendar-check"></i>
                            <span>{{ profile.giorni_attivi or 0 }} giorni attivi</span>
                        </div>
                        <div class="quick-stat">
                            <i class="fas fa-medal"></i>
                            <span id="badgeCount">0</span> badge
                        </div>
                        <div class="quick-stat">
                            <i class="fas fa-check-circle"></i>
                            <span>{{ profile.sfide_completate or 0 }} sfide</span>
                        </div>
                    </div>
                </div>

                <div class="gami-streak-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-fire-alt"></i> Streak & Bonus</h3>
                    </div>
                    <div class="streak-display">
                        <div class="streak-flame-container">
                            <span class="streak-flame-emoji" id="streakEmoji">{{ 'üî•' if profile.streak_corrente and profile.streak_corrente > 0 else '‚ùÑÔ∏è' }}</span>
                            <span class="streak-count" id="streakCount">{{ profile.streak_corrente or 0 }}</span>
                        </div>
                        <p class="streak-label">giorni consecutivi</p>
                    </div>
                    
                    <div class="streak-bonus-list">
                        <div class="bonus-item {% if profile.streak_corrente and profile.streak_corrente >= 3 %}active{% endif %}">
                            <span class="bonus-icon">3Ô∏è‚É£</span>
                            <span class="bonus-text">+5% XP (3 giorni)</span>
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="bonus-item {% if profile.streak_corrente and profile.streak_corrente >= 7 %}active{% endif %}">
                            <span class="bonus-icon">7Ô∏è‚É£</span>
                            <span class="bonus-text">+10% XP (7 giorni)</span>
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="bonus-item {% if profile.streak_corrente and profile.streak_corrente >= 14 %}active{% endif %}">
                            <span class="bonus-icon">üî•</span>
                            <span class="bonus-text">+15% XP (14 giorni)</span>
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="bonus-item {% if profile.streak_corrente and profile.streak_corrente >= 30 %}active{% endif %}">
                            <span class="bonus-icon">üíé</span>
                            <span class="bonus-text">+25% XP (30 giorni)</span>
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bento-grid challenges-layout">
                <div class="gami-challenge-card daily">
                    <div class="challenge-header">
                        <div class="challenge-type-badge daily">
                            <i class="fas fa-sun"></i> Sfida Giornaliera
                        </div>
                        <span class="challenge-timer" id="dailyTimer">
                            <i class="fas fa-clock"></i> <span>--:--:--</span>
                        </span>
                    </div>
                    <div class="challenge-content" id="dailyChallengeContent">
                        <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                    </div>
                </div>

                <div class="gami-challenge-card weekly">
                    <div class="challenge-header">
                        <div class="challenge-type-badge weekly">
                            <i class="fas fa-calendar-week"></i> Sfida Settimanale
                        </div>
                        <span class="challenge-timer" id="weeklyTimer">
                            <i class="fas fa-clock"></i> <span>--g --:--:--</span>
                        </span>
                    </div>
                    <div class="challenge-content" id="weeklyChallengeContent">
                        <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                    </div>
                </div>

                <div class="gami-challenges-list-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-tasks"></i> Tutte le Sfide Attive</h3>
                        <span class="challenges-count" id="challengesCount">0</span>
                    </div>
                    <div class="challenges-list" id="allChallengesList">
                        <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                    </div>
                </div>
            </div>

            <div class="bento-grid balanced-layout">
                <div class="gami-badges-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-award"></i> Badge Sbloccati</h3>
                        <a href="#" class="card-action" onclick="openBadgesModal(); return false;">Vedi tutti</a>
                    </div>
                    <div class="badges-showcase" id="badgesShowcase">
                        <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                    </div>
                    <div class="badges-progress-summary" id="badgesProgress"></div>
                </div>

                <div class="gami-leaderboard-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-trophy"></i> Classifica</h3>
                        <div class="leaderboard-tabs">
                            <button class="lb-tab active" data-period="weekly">Settimana</button>
                            <button class="lb-tab" data-period="monthly">Mese</button>
                            <button class="lb-tab" data-period="lifetime">Sempre</button>
                        </div>
                    </div>
                    <div class="leaderboard-list" id="leaderboardList">
                        <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                    </div>
                    <div class="your-position" id="yourPosition"></div>
                </div>

                <div class="gami-powerups-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-bolt"></i> Power-ups</h3>
                    </div>
                    <div class="powerups-grid" id="powerupsGrid">
                        <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                    </div>
                </div>
            </div>

            <div class="bento-grid kudos-layout">
                <div class="gami-kudos-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-heart"></i> Kudos Ricevuti</h3>
                        <span class="kudos-total" id="kudosTotal">0 kudos</span>
                    </div>
                    <div class="kudos-list" id="kudosList">
                        <div class="empty-state">
                            <i class="fas fa-heart"></i>
                            <p>Non hai ancora ricevuto kudos</p>
                            <span>Aiuta i compagni per riceverne!</span>
                        </div>
                    </div>
                </div>

                <div class="gami-activity-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-history"></i> Attivita Recente</h3>
                    </div>
                    <div class="activity-timeline" id="activityTimeline">
                        <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                    </div>
                </div>
            </div>

            <div class="gami-ranks-overview">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-layer-group"></i> Percorso dei Ranghi</h3>
                </div>
                <div class="ranks-progression" id="ranksProgression"></div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="badgesModal">
        <div class="modal-content badges-modal">
            <div class="modal-header">
                <h3><i class="fas fa-award"></i> Tutti i Badge</h3>
                <button class="modal-close" onclick="closeBadgesModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="badges-grid-full" id="allBadgesGrid"></div>
            </div>
        </div>
    </div>

    <script>
        const currentUserId = {{ user.id if user else 0 }};
        let profileData = {};
        
        document.addEventListener('DOMContentLoaded', function() {
            initSidebar();
            initLeaderboardTabs();
            initChallengeTimers();
            loadAllData();
        });

        function initSidebar() {
            const toggle = document.getElementById('sidebarToggle');
            const container = document.getElementById('dashboardContainer');
            toggle?.addEventListener('click', () => container.classList.toggle('sidebar-collapsed'));
        }

        async function loadAllData() {
            await Promise.all([
                loadProfile(),
                loadChallenges(),
                loadBadges(),
                loadLeaderboard('weekly'),
                loadPowerups(),
                loadRanks(),
                loadActivity()
            ]);
        }

        async function loadProfile() {
            try {
                const response = await fetch('/api/gamification/v2/profile');
                if (response.ok) {
                    profileData = await response.json();
                    updateProfileUI(profileData);
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        function updateProfileUI(data) {
            document.getElementById('headerStreak').textContent = data.streak_corrente || 0;
            document.getElementById('headerXP').textContent = data.xp_totale || 0;
            document.getElementById('streakCount').textContent = data.streak_corrente || 0;
            document.getElementById('streakEmoji').textContent = data.streak_corrente > 0 ? 'üî•' : '‚ùÑÔ∏è';
            
            const progressFill = document.getElementById('xpProgressFill');
            if (progressFill) progressFill.style.width = `${data.progress_percentage || 0}%`;
            
            document.querySelectorAll('.bonus-item').forEach((item, index) => {
                const thresholds = [3, 7, 14, 30];
                item.classList.toggle('active', data.streak_corrente >= thresholds[index]);
            });
        }

        async function loadChallenges() {
            try {
                const [dailyRes, weeklyRes, allRes] = await Promise.all([
                    fetch('/api/gamification/v2/challenges/daily'),
                    fetch('/api/gamification/v2/challenges/weekly'),
                    fetch('/api/gamification/v2/challenges/active')
                ]);
                
                const daily = dailyRes.ok ? await dailyRes.json() : null;
                const weekly = weeklyRes.ok ? await weeklyRes.json() : null;
                const all = allRes.ok ? await allRes.json() : [];
                
                renderDailyChallenge(daily);
                renderWeeklyChallenge(weekly);
                renderAllChallenges(all);
            } catch (error) {
                console.error('Error loading challenges:', error);
            }
        }

        function renderDailyChallenge(challenge) {
            const container = document.getElementById('dailyChallengeContent');
            if (!challenge || challenge.completato) {
                container.innerHTML = `
                    <div class="challenge-empty">
                        <i class="fas fa-check-double"></i>
                        <p>Sfida giornaliera completata!</p>
                        <span>Nuova sfida domani alle 00:00</span>
                    </div>`;
            } else {
                const progress = Math.min(100, ((challenge.progresso_attuale || 0) / (challenge.obiettivo || 1)) * 100);
                container.innerHTML = `
                    <h4 class="challenge-name">${challenge.nome || 'Sfida del giorno'}</h4>
                    <p class="challenge-desc">${challenge.descrizione || ''}</p>
                    <div class="challenge-progress-section">
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${progress}%;"></div>
                        </div>
                        <span class="progress-text">${challenge.progresso_attuale || 0}/${challenge.obiettivo || 1}</span>
                    </div>
                    <div class="challenge-reward"><i class="fas fa-coins"></i> +${challenge.reward_xp || 50} XP</div>`;
            }
        }

        function renderWeeklyChallenge(challenge) {
            const container = document.getElementById('weeklyChallengeContent');
            if (!challenge || challenge.completato) {
                container.innerHTML = `
                    <div class="challenge-empty">
                        <i class="fas fa-trophy"></i>
                        <p>Sfida settimanale completata!</p>
                        <span>Nuova sfida lunedi alle 00:00</span>
                    </div>`;
            } else {
                const progress = Math.min(100, ((challenge.progresso_attuale || 0) / (challenge.obiettivo || 1)) * 100);
                container.innerHTML = `
                    <h4 class="challenge-name">${challenge.nome || 'Sfida della settimana'}</h4>
                    <p class="challenge-desc">${challenge.descrizione || ''}</p>
                    <div class="challenge-progress-section">
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${progress}%;"></div>
                        </div>
                        <span class="progress-text">${challenge.progresso_attuale || 0}/${challenge.obiettivo || 1}</span>
                    </div>
                    <div class="challenge-reward"><i class="fas fa-coins"></i> +${challenge.reward_xp || 200} XP</div>`;
            }
        }

        function renderAllChallenges(challenges) {
            const container = document.getElementById('allChallengesList');
            document.getElementById('challengesCount').textContent = challenges.length;
            
            if (!challenges.length) {
                container.innerHTML = `<div class="empty-state"><i class="fas fa-clipboard-check"></i><p>Nessuna sfida attiva</p></div>`;
                return;
            }
            
            container.innerHTML = challenges.map(c => {
                const progress = Math.min(100, ((c.progresso_attuale || 0) / (c.obiettivo || 1)) * 100);
                const icon = c.tipo === 'giornaliera' ? 'fa-sun' : c.tipo === 'settimanale' ? 'fa-calendar-week' : 'fa-users';
                return `
                    <div class="challenge-list-item">
                        <div class="challenge-list-icon ${c.tipo}"><i class="fas ${icon}"></i></div>
                        <div class="challenge-list-info">
                            <h5>${c.nome}</h5>
                            <div class="mini-progress-bar"><div class="mini-progress-fill" style="width: ${progress}%;"></div></div>
                        </div>
                        <div class="challenge-list-reward">+${c.reward_xp} XP</div>
                    </div>`;
            }).join('');
        }

        async function loadBadges() {
            try {
                const [unlockedRes, allRes] = await Promise.all([
                    fetch('/api/gamification/v2/badges'),
                    fetch('/api/gamification/v2/badges/all')
                ]);
                
                const unlocked = unlockedRes.ok ? await unlockedRes.json() : [];
                const all = allRes.ok ? await allRes.json() : [];
                
                renderBadgesShowcase(unlocked);
                renderBadgesProgress(unlocked.length, all.length);
                document.getElementById('badgeCount').textContent = unlocked.length;
            } catch (error) {
                console.error('Error loading badges:', error);
            }
        }

        function renderBadgesShowcase(badges) {
            const container = document.getElementById('badgesShowcase');
            if (!badges.length) {
                container.innerHTML = `<div class="empty-badges"><i class="fas fa-lock"></i><p>Completa sfide per sbloccare badge!</p></div>`;
                return;
            }
            
            container.innerHTML = badges.slice(0, 6).map(b => `
                <div class="badge-item ${b.rarita}" title="${b.nome}: ${b.descrizione}">
                    <span class="badge-icon">${b.icon || 'üèÖ'}</span>
                    <span class="badge-name">${b.nome}</span>
                    <span class="badge-rarity">${(b.rarita || 'comune').charAt(0).toUpperCase() + (b.rarita || 'comune').slice(1)}</span>
                </div>`).join('');
        }

        function renderBadgesProgress(unlocked, total) {
            const container = document.getElementById('badgesProgress');
            if (total > 0) {
                const percent = Math.round((unlocked / total) * 100);
                container.innerHTML = `
                    <span>${unlocked}/${total} badge sbloccati</span>
                    <div class="badges-mini-progress"><div class="badges-mini-fill" style="width: ${percent}%;"></div></div>`;
            }
        }

        function initLeaderboardTabs() {
            document.querySelectorAll('.lb-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.lb-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    loadLeaderboard(this.dataset.period);
                });
            });
        }

        async function loadLeaderboard(period) {
            try {
                const response = await fetch(`/api/gamification/v2/leaderboard?period=${period}&limit=10`);
                const data = response.ok ? await response.json() : [];
                renderLeaderboard(data);
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        function renderLeaderboard(entries) {
            const container = document.getElementById('leaderboardList');
            if (!entries.length) {
                container.innerHTML = `<div class="empty-state"><i class="fas fa-users"></i><p>Classifica vuota</p></div>`;
                return;
            }
            
            container.innerHTML = entries.map((entry, i) => {
                const position = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i + 1}`;
                const isCurrentUser = entry.user_id === currentUserId;
                return `
                    <div class="leaderboard-item ${isCurrentUser ? 'current-user' : ''} ${i < 3 ? 'top-3' : ''}">
                        <div class="lb-position">${i < 3 ? `<span class="position-medal">${position}</span>` : `<span class="position-number">${position}</span>`}</div>
                        <div class="lb-user">
                            <div class="lb-avatar">${(entry.nome || 'U')[0]}${(entry.cognome || '')[0]}</div>
                            <div class="lb-name">${entry.nome || 'Utente'} ${(entry.cognome || '')[0] || ''}.${isCurrentUser ? ' <span class="you-badge">Tu</span>' : ''}</div>
                        </div>
                        <div class="lb-rank-badge">${entry.rank_icon || 'üå±'}</div>
                        <div class="lb-xp">${entry.xp_totale || 0} XP</div>
                    </div>`;
            }).join('');
            
            const myEntry = entries.find(e => e.user_id === currentUserId);
            const positionEl = document.getElementById('yourPosition');
            if (myEntry) {
                const myPos = entries.indexOf(myEntry) + 1;
                positionEl.innerHTML = `<i class="fas fa-map-marker-alt"></i> La tua posizione: <strong>#${myPos}</strong>`;
            } else {
                positionEl.innerHTML = '';
            }
        }

        async function loadPowerups() {
            try {
                const response = await fetch('/api/gamification/v2/powerups');
                const data = response.ok ? await response.json() : [];
                renderPowerups(data);
            } catch (error) {
                console.error('Error loading powerups:', error);
            }
        }

        function renderPowerups(powerups) {
            const container = document.getElementById('powerupsGrid');
            if (!powerups.length) {
                container.innerHTML = `<div class="empty-state"><i class="fas fa-box-open"></i><p>Nessun power-up disponibile</p></div>`;
                return;
            }
            
            container.innerHTML = powerups.map(p => `
                <div class="powerup-item ${p.owned ? 'owned' : ''} ${p.active ? 'active' : ''}">
                    <div class="powerup-icon">${p.icon || '‚ö°'}</div>
                    <div class="powerup-info">
                        <h5>${p.nome}</h5>
                        <p>${p.descrizione}</p>
                    </div>
                    ${p.owned ? `<span class="powerup-count">x${p.quantita || 1}</span>` : ''}
                    ${p.active ? '<span class="powerup-active-badge">Attivo</span>' : ''}
                </div>`).join('');
        }

        async function loadRanks() {
            try {
                const response = await fetch('/api/gamification/v2/ranks');
                const ranks = response.ok ? await response.json() : [];
                renderRanksProgression(ranks);
            } catch (error) {
                console.error('Error loading ranks:', error);
            }
        }

        function renderRanksProgression(ranks) {
            const container = document.getElementById('ranksProgression');
            const currentXP = profileData.xp_totale || 0;
            const currentRank = profileData.rango || 'Germoglio';
            
            container.innerHTML = ranks.map(r => {
                const achieved = currentXP >= r.min_xp;
                const isCurrent = r.nome === currentRank;
                return `
                    <div class="rank-step ${achieved ? 'achieved' : ''} ${isCurrent ? 'current' : ''}">
                        <div class="rank-step-icon" style="background: ${r.color || '#10B981'};">
                            <span>${r.icon || 'üå±'}</span>
                        </div>
                        <div class="rank-step-info">
                            <span class="rank-step-name">${r.nome}</span>
                            <span class="rank-step-xp">${r.min_xp} XP</span>
                        </div>
                    </div>`;
            }).join('');
        }

        async function loadActivity() {
            try {
                const response = await fetch('/api/gamification/v2/activity?limit=8');
                const data = response.ok ? await response.json() : [];
                renderActivity(data);
            } catch (error) {
                console.error('Error loading activity:', error);
                document.getElementById('activityTimeline').innerHTML = `<div class="empty-state"><i class="fas fa-clock"></i><p>Nessuna attivita recente</p></div>`;
            }
        }

        function renderActivity(activities) {
            const container = document.getElementById('activityTimeline');
            if (!activities.length) {
                container.innerHTML = `<div class="empty-state"><i class="fas fa-clock"></i><p>Nessuna attivita recente</p></div>`;
                return;
            }
            
            const iconMap = {
                'xp_earned': 'fa-star',
                'badge_unlocked': 'fa-award',
                'challenge_completed': 'fa-check-circle',
                'rank_up': 'fa-arrow-up',
                'kudos': 'fa-heart'
            };
            
            container.innerHTML = activities.map(a => `
                <div class="activity-item">
                    <div class="activity-icon ${a.tipo || ''}">
                        <i class="fas ${iconMap[a.tipo] || 'fa-bolt'}"></i>
                    </div>
                    <div class="activity-content">
                        <p>${a.descrizione || 'Attivita'}</p>
                        <span class="activity-time">${a.created_at || ''}</span>
                    </div>
                    ${a.xp_earned ? `<span class="activity-xp">+${a.xp_earned} XP</span>` : ''}
                </div>`).join('');
        }

        function initChallengeTimers() {
            updateTimers();
            setInterval(updateTimers, 1000);
        }

        function updateTimers() {
            const now = new Date();
            
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            const dailyDiff = tomorrow - now;
            const dailyH = Math.floor(dailyDiff / 3600000);
            const dailyM = Math.floor((dailyDiff % 3600000) / 60000);
            const dailyS = Math.floor((dailyDiff % 60000) / 1000);
            document.querySelector('#dailyTimer span').textContent = 
                `${String(dailyH).padStart(2, '0')}:${String(dailyM).padStart(2, '0')}:${String(dailyS).padStart(2, '0')}`;
            
            const nextMonday = new Date(now);
            nextMonday.setDate(now.getDate() + ((1 + 7 - now.getDay()) % 7 || 7));
            nextMonday.setHours(0, 0, 0, 0);
            const weeklyDiff = nextMonday - now;
            const days = Math.floor(weeklyDiff / 86400000);
            const weeklyH = Math.floor((weeklyDiff % 86400000) / 3600000);
            const weeklyM = Math.floor((weeklyDiff % 3600000) / 60000);
            const weeklyS = Math.floor((weeklyDiff % 60000) / 1000);
            document.querySelector('#weeklyTimer span').textContent = 
                `${days}g ${String(weeklyH).padStart(2, '0')}:${String(weeklyM).padStart(2, '0')}:${String(weeklyS).padStart(2, '0')}`;
        }

        function openBadgesModal() {
            document.getElementById('badgesModal').style.display = 'flex';
            loadAllBadges();
        }

        function closeBadgesModal() {
            document.getElementById('badgesModal').style.display = 'none';
        }

        async function loadAllBadges() {
            try {
                const response = await fetch('/api/gamification/v2/badges/all');
                const badges = response.ok ? await response.json() : [];
                
                document.getElementById('allBadgesGrid').innerHTML = badges.map(b => `
                    <div class="badge-full-item ${b.rarita || 'comune'} ${b.unlocked ? 'unlocked' : 'locked'}">
                        <div class="badge-icon-large">${b.icon || 'üèÖ'}</div>
                        <h4>${b.nome}</h4>
                        <p>${b.descrizione}</p>
                        <span class="badge-rarity-tag">${b.rarita || 'comune'}</span>
                        ${b.unlocked ? `<span class="unlocked-date">Sbloccato</span>` : '<span class="locked-hint">Non sbloccato</span>'}
                    </div>`).join('');
            } catch (error) {
                console.error('Error loading all badges:', error);
            }
        }

        document.getElementById('badgesModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeBadgesModal();
        });
    </script>
</body>
</html>
