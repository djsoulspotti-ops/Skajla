
<!-- AI ASSISTANT MODAL -->
<div id="aiAssistantModal" class="modal-overlay" style="display: none;">
    <div class="ai-chat-container">
        <div class="ai-header">
            <div class="ai-info">
                <div class="ai-avatar" id="aiAvatar">ü§ñ</div>
                <div class="ai-details">
                    <h3 id="aiBotName">SKAILA Assistant</h3>
                    <p>Il tuo tutor personale AI</p>
                </div>
            </div>
            <button class="close-btn" onclick="closeAIAssistant()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-welcome-message">
                <div class="message ai-message">
                    <div class="message-content">
                        <strong>Benvenuto! üëã</strong><br>
                        Sono il tuo assistente AI personalizzato per SKAILA. Posso aiutarti con:
                        <ul>
                            <li>üìö Spiegazioni personalizzate</li>
                            <li>üéØ Esercizi su misura</li>
                            <li>üìä Analisi del tuo progresso</li>
                            <li>üí° Suggerimenti di studio</li>
                        </ul>
                        Come posso aiutarti oggi?
                    </div>
                </div>
            </div>
        </div>

        <div class="ai-input-container">
            <form id="aiChatForm" class="ai-chat-form">
                <div class="ai-input-wrapper">
                    <input type="text" 
                           id="aiMessageInput" 
                           placeholder="Scrivi la tua domanda..." 
                           autocomplete="off">
                    <button type="submit" class="ai-send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
            
            <div class="ai-quick-actions">
                <button class="quick-action-btn" onclick="sendQuickMessage('Aiutami con la matematica')">
                    üìä Matematica
                </button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Spiegami informatica')">
                    üíª Informatica
                </button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Test di comprensione')">
                    üß† Quiz
                </button>
                <button class="quick-action-btn" onclick="openAIDashboard()">
                    üìà Dashboard
                </button>
            </div>
        </div>
    </div>
</div>

<!-- AI SETTINGS MODAL -->
<div id="aiSettingsModal" class="modal-overlay" style="display: none;">
    <div class="ai-settings-container">
        <div class="modal-header">
            <h3><i class="fas fa-robot"></i> Impostazioni AI Assistant</h3>
            <button class="close-btn" onclick="closeAISettings()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="settings-content">
            <div class="setting-group">
                <label>ü§ñ Nome del Bot</label>
                <input type="text" id="botNameInput" placeholder="Nome personalizzato...">
            </div>

            <div class="setting-group">
                <label>üé≠ Avatar del Bot</label>
                <div class="avatar-selector">
                    <span class="avatar-option" onclick="selectAvatar('ü§ñ')">ü§ñ</span>
                    <span class="avatar-option" onclick="selectAvatar('üß†')">üß†</span>
                    <span class="avatar-option" onclick="selectAvatar('üë©‚Äçüè´')">üë©‚Äçüè´</span>
                    <span class="avatar-option" onclick="selectAvatar('üë®‚Äçüè´')">üë®‚Äçüè´</span>
                    <span class="avatar-option" onclick="selectAvatar('ü¶â')">ü¶â</span>
                    <span class="avatar-option" onclick="selectAvatar('‚≠ê')">‚≠ê</span>
                </div>
            </div>

            <div class="setting-group">
                <label>üìö Stile di Apprendimento</label>
                <select id="learningStyleSelect">
                    <option value="visual">Visuale (diagrammi, mappe)</option>
                    <option value="auditory">Uditivo (spiegazioni verbali)</option>
                    <option value="kinesthetic">Cinestetico (esempi pratici)</option>
                    <option value="reading">Lettura/Scrittura</option>
                    <option value="adaptive">Adattivo (misto)</option>
                </select>
            </div>

            <div class="setting-group">
                <label>üéØ Livello di Difficolt√†</label>
                <select id="difficultySelect">
                    <option value="easy">Facile</option>
                    <option value="medium">Medio</option>
                    <option value="hard">Difficile</option>
                    <option value="adaptive">Adattivo</option>
                </select>
            </div>

            <div class="setting-group">
                <label>üí¨ Tono di Conversazione</label>
                <select id="conversationToneSelect">
                    <option value="friendly">Amichevole</option>
                    <option value="supportive">Supportivo</option>
                    <option value="professional">Professionale</option>
                    <option value="motivational">Motivazionale</option>
                </select>
            </div>

            <div class="setting-group">
                <label>üí™ Materie Forti</label>
                <div class="subject-tags">
                    <div class="subject-tag" data-subject="matematica">Matematica</div>
                    <div class="subject-tag" data-subject="informatica">Informatica</div>
                    <div class="subject-tag" data-subject="italiano">Italiano</div>
                    <div class="subject-tag" data-subject="inglese">Inglese</div>
                    <div class="subject-tag" data-subject="fisica">Fisica</div>
                    <div class="subject-tag" data-subject="storia">Storia</div>
                </div>
            </div>

            <div class="setting-group">
                <label>üìà Materie da Migliorare</label>
                <div class="subject-tags weak-subjects">
                    <div class="subject-tag" data-subject="matematica">Matematica</div>
                    <div class="subject-tag" data-subject="informatica">Informatica</div>
                    <div class="subject-tag" data-subject="italiano">Italiano</div>
                    <div class="subject-tag" data-subject="inglese">Inglese</div>
                    <div class="subject-tag" data-subject="fisica">Fisica</div>
                    <div class="subject-tag" data-subject="storia">Storia</div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeAISettings()">Annulla</button>
            <button class="btn-primary" onclick="saveAISettings()">Salva Impostazioni</button>
        </div>
    </div>
</div>

<!-- AI DASHBOARD MODAL -->
<div id="aiDashboardModal" class="modal-overlay" style="display: none;">
    <div class="ai-dashboard-container">
        <div class="modal-header">
            <h3><i class="fas fa-chart-line"></i> Dashboard Apprendimento</h3>
            <button class="close-btn" onclick="closeAIDashboard()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="dashboard-content" id="dashboardContent">
            <div class="loading">
                <div class="spinner"></div>
                Caricamento dashboard...
            </div>
        </div>
    </div>
</div>

<style>
.ai-chat-container {
    background: white;
    border-radius: 15px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
}

.ai-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.ai-info {
    display: flex;
    align-items: center;
    gap: 0.8rem;
}

.ai-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.ai-chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    max-height: 400px;
}

.ai-message {
    background: #f8f9fa;
    margin-bottom: 1rem;
    padding: 1rem;
    border-radius: 12px;
    border-left: 4px solid #667eea;
}

.user-message {
    background: #667eea;
    color: white;
    text-align: right;
    border-left: none;
    border-right: 4px solid #764ba2;
}

.ai-input-container {
    border-top: 1px solid #e9ecef;
    padding: 1rem;
}

.ai-chat-form {
    margin-bottom: 1rem;
}

.ai-input-wrapper {
    display: flex;
    gap: 0.5rem;
}

.ai-input-wrapper input {
    flex: 1;
    padding: 0.8rem;
    border: 2px solid #e9ecef;
    border-radius: 25px;
    outline: none;
}

.ai-input-wrapper input:focus {
    border-color: #667eea;
}

.ai-send-btn {
    background: #667eea;
    color: white;
    border: none;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.ai-quick-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.quick-action-btn {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 20px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
}

.quick-action-btn:hover {
    background: #667eea;
    color: white;
}

.ai-settings-container, .ai-dashboard-container {
    background: white;
    border-radius: 15px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
}

.setting-group {
    margin-bottom: 1.5rem;
}

.setting-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #333;
}

.setting-group input, .setting-group select {
    width: 100%;
    padding: 0.8rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    outline: none;
}

.avatar-selector {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.avatar-option {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
}

.avatar-option:hover, .avatar-option.selected {
    border-color: #667eea;
    background: #e8f0fe;
}

.subject-tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.subject-tag {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 20px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    transition: all 0.2s;
}

.subject-tag.selected {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.subject-tag:hover {
    border-color: #667eea;
}

.dashboard-content {
    padding: 1.5rem;
}

.metric-card {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    border-left: 4px solid #667eea;
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    color: #667eea;
}

.metric-label {
    color: #666;
    margin-top: 0.5rem;
}

.recommendations {
    margin-top: 2rem;
}

.recommendation-item {
    background: #e8f0fe;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    border-left: 3px solid #667eea;
}
</style>

<script>
// AI Chatbot Functions
let aiProfile = null;
let aiConversationHistory = [];

function openAIAssistant() {
    document.getElementById('aiAssistantModal').style.display = 'flex';
    loadAIProfile();
}

function closeAIAssistant() {
    document.getElementById('aiAssistantModal').style.display = 'none';
}

function openAISettings() {
    document.getElementById('aiSettingsModal').style.display = 'flex';
    loadAIProfile();
}

function closeAISettings() {
    document.getElementById('aiSettingsModal').style.display = 'none';
}

function openAIDashboard() {
    document.getElementById('aiDashboardModal').style.display = 'flex';
    loadAIDashboard();
}

function closeAIDashboard() {
    document.getElementById('aiDashboardModal').style.display = 'none';
}

async function loadAIProfile() {
    try {
        const response = await fetch('/api/ai/profile');
        
        if (!response.ok) {
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            throw new Error(`HTTP ${response.status}`);
        }
        
        const profile = await response.json();
        aiProfile = profile;
        
        // Aggiorna UI
        document.getElementById('aiBotName').textContent = profile.bot_name;
        document.getElementById('aiAvatar').textContent = profile.bot_avatar;
        
        if (document.getElementById('botNameInput')) {
            document.getElementById('botNameInput').value = profile.bot_name;
            document.getElementById('learningStyleSelect').value = profile.learning_style;
            document.getElementById('difficultySelect').value = profile.difficulty_preference;
            document.getElementById('conversationToneSelect').value = profile.conversation_tone;
            
            // Aggiorna materie selezionate
            updateSubjectTags(profile.strong_subjects, profile.weak_subjects);
        }
    } catch (error) {
        console.error('Errore caricamento profilo AI:', error);
    }
}

function updateSubjectTags(strongSubjects, weakSubjects) {
    // Reset all tags
    document.querySelectorAll('.subject-tag').forEach(tag => {
        tag.classList.remove('selected');
    });
    
    // Mark strong subjects
    strongSubjects.forEach(subject => {
        const tag = document.querySelector(`.subject-tags:not(.weak-subjects) [data-subject="${subject}"]`);
        if (tag) tag.classList.add('selected');
    });
    
    // Mark weak subjects
    weakSubjects.forEach(subject => {
        const tag = document.querySelector(`.weak-subjects [data-subject="${subject}"]`);
        if (tag) tag.classList.add('selected');
    });
}

function selectAvatar(avatar) {
    document.querySelectorAll('.avatar-option').forEach(option => {
        option.classList.remove('selected');
    });
    event.target.classList.add('selected');
    document.getElementById('aiAvatar').textContent = avatar;
}

// Toggle subject selection
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('subject-tag')) {
        e.target.classList.toggle('selected');
    }
});

async function saveAISettings() {
    const strongSubjects = Array.from(document.querySelectorAll('.subject-tags:not(.weak-subjects) .subject-tag.selected'))
                              .map(tag => tag.dataset.subject);
    const weakSubjects = Array.from(document.querySelectorAll('.weak-subjects .subject-tag.selected'))
                            .map(tag => tag.dataset.subject);
    
    const settings = {
        bot_name: document.getElementById('botNameInput').value || 'SKAILA Assistant',
        bot_avatar: document.querySelector('.avatar-option.selected')?.textContent || 'ü§ñ',
        learning_style: document.getElementById('learningStyleSelect').value,
        difficulty_preference: document.getElementById('difficultySelect').value,
        conversation_tone: document.getElementById('conversationToneSelect').value,
        strong_subjects: strongSubjects,
        weak_subjects: weakSubjects
    };
    
    try {
        const response = await fetch('/api/ai/profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settings)
        });
        
        if (response.ok) {
            showNotification('Successo', 'Impostazioni AI salvate!', 'success');
            closeAISettings();
            loadAIProfile();
        } else {
            throw new Error('Errore salvataggio');
        }
    } catch (error) {
        showNotification('Errore', 'Impossibile salvare le impostazioni', 'error');
    }
}

// AI Chat Form Handler
document.getElementById('aiChatForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const input = document.getElementById('aiMessageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addAIMessage(message, 'user');
    input.value = '';
    
    // Show typing indicator
    showAITyping();
    
    try {
        const response = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: message })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            hideAITyping();
            addAIMessage(data.response, 'ai', data.bot_avatar);
        } else {
            throw new Error(data.error || 'Errore AI');
        }
    } catch (error) {
        hideAITyping();
        addAIMessage('Mi dispiace, c\'√® stato un errore. Riprova tra poco! üòÖ', 'ai');
    }
});

function addAIMessage(content, sender, avatar = 'ü§ñ') {
    const messagesContainer = document.getElementById('aiChatMessages');
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    if (sender === 'ai') {
        messageDiv.innerHTML = `
            <div class="message-header">
                <span class="ai-avatar">${avatar}</span>
                <span class="message-time">${new Date().toLocaleTimeString()}</span>
            </div>
            <div class="message-content">${content}</div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="message-content">${content}</div>
            <div class="message-time">${new Date().toLocaleTimeString()}</div>
        `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showAITyping() {
    const messagesContainer = document.getElementById('aiChatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'ai-typing';
    typingDiv.className = 'message ai-message';
    typingDiv.innerHTML = `
        <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
        </div>
    `;
    messagesContainer.appendChild(typingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideAITyping() {
    const typingDiv = document.getElementById('ai-typing');
    if (typingDiv) {
        typingDiv.remove();
    }
}

function sendQuickMessage(message) {
    document.getElementById('aiMessageInput').value = message;
    document.getElementById('aiChatForm').dispatchEvent(new Event('submit'));
}

async function loadAIDashboard() {
    const dashboardContent = document.getElementById('dashboardContent');
    dashboardContent.innerHTML = '<div class="loading"><div class="spinner"></div>Caricamento dashboard...</div>';
    
    try {
        const response = await fetch('/api/ai/dashboard');
        const dashboard = await response.json();
        
        dashboardContent.innerHTML = `
            <div class="dashboard-metrics">
                <div class="metric-card">
                    <div class="metric-value">${Math.round(dashboard.progress_metrics.overall_progress)}%</div>
                    <div class="metric-label">Progresso Complessivo</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${Math.round(dashboard.progress_metrics.consistency)}%</div>
                    <div class="metric-label">Costanza di Studio</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${dashboard.learning_analytics.total_interactions || 0}</div>
                    <div class="metric-label">Interazioni Totali</div>
                </div>
            </div>
            
            <div class="recommendations">
                <h4>üìã Raccomandazioni Personalizzate</h4>
                ${dashboard.recommendations.map(rec => `
                    <div class="recommendation-item">${rec}</div>
                `).join('')}
            </div>
            
            <div class="daily-goals">
                <h4>üéØ Obiettivi Giornalieri</h4>
                ${dashboard.daily_goals.map(goal => `
                    <div class="recommendation-item">‚úì ${goal}</div>
                `).join('')}
            </div>
        `;
    } catch (error) {
        dashboardContent.innerHTML = '<div class="error">Errore caricamento dashboard</div>';
    }
}

// Typing indicator CSS
const style = document.createElement('style');
style.textContent = `
.typing-indicator {
    display: flex;
    align-items: center;
    gap: 0.3rem;
}

.typing-indicator span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #667eea;
    animation: typing 1.4s ease-in-out infinite;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: scale(1);
        opacity: 0.5;
    }
    30% {
        transform: scale(1.2);
        opacity: 1;
    }
}
`;
document.head.appendChild(style);

// Initialize AI on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAIProfile();
});
</script>
