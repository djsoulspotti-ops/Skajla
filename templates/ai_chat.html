<!-- AI ASSISTANT MODAL -->
<div id="aiAssistantModal" class="modal-overlay" style="display: none;">
    <div class="ai-chat-container">
        <div class="ai-header">
            <div class="ai-info">
                <div class="ai-avatar" id="aiAvatar">ü§ñ</div>
                <div class="ai-details">
                    <h3 id="aiBotName">SKAILA Assistant</h3>
                    <p>Il tuo tutor personale AI</p>
                </div>
            </div>
            <button class="close-btn" onclick="closeAIAssistant()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-welcome-message">
                <div class="message ai-message">
                    <div class="message-content">
                        <strong>Benvenuto! üëã</strong><br>
                        Sono il tuo assistente AI personalizzato per SKAILA. Posso aiutarti con:
                        <ul>
                            <li>üìö Spiegazioni personalizzate</li>
                            <li>üéØ Esercizi su misura</li>
                            <li>üìä Analisi del tuo progresso</li>
                            <li>üí° Suggerimenti di studio</li>
                        </ul>
                        Come posso aiutarti oggi?
                    </div>
                </div>
            </div>
        </div>

        <div class="ai-input-container">
            <form id="aiChatForm" class="ai-chat-form">
                <div class="ai-input-wrapper">
                    <input type="text" 
                           id="aiMessageInput" 
                           placeholder="Scrivi la tua domanda..." 
                           autocomplete="off">
                    <button type="submit" class="ai-send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>

            <div class="ai-quick-actions">
                <button class="quick-action-btn" onclick="sendQuickMessage('Aiutami con la matematica')">
                    üìä Matematica
                </button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Spiegami informatica')">
                    üíª Informatica
                </button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Test di comprensione')">
                    üß† Quiz
                </button>
                <button class="quick-action-btn" onclick="openAIDashboard()">
                    üìà Dashboard
                </button>
            </div>
        </div>
    </div>
</div>

<!-- AI SETTINGS MODAL -->
<div id="aiSettingsModal" class="modal-overlay" style="display: none;">
    <div class="ai-settings-container">
        <div class="modal-header">
            <h3><i class="fas fa-robot"></i> Impostazioni AI Assistant</h3>
            <button class="close-btn" onclick="closeAISettings()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="ai-settings-content">
            <div class="setting-group">
                <label>ü§ñ Nome del Bot</label>
                <input type="text" id="botNameInput" placeholder="Nome personalizzato...">
            </div>

            <div class="setting-group">
                <label>üé≠ Avatar del Bot</label>
                <div class="avatar-selector">
                    <span class="avatar-option" onclick="selectAvatar('ü§ñ')">ü§ñ</span>
                    <span class="avatar-option" onclick="selectAvatar('üß†')">üß†</span>
                    <span class="avatar-option" onclick="selectAvatar('üë©‚Äçüè´')">üë©‚Äçüè´</span>
                    <span class="avatar-option" onclick="selectAvatar('üë®‚Äçüè´')">üë®‚Äçüè´</span>
                    <span class="avatar-option" onclick="selectAvatar('ü¶â')">ü¶â</span>
                    <span class="avatar-option" onclick="selectAvatar('‚≠ê')">‚≠ê</span>
                </div>
            </div>

            <div class="setting-group">
                <label>üí¨ Tono di Conversazione</label>
                <select id="conversationStyle">
                    <option value="friendly">Amichevole</option>
                    <option value="supportive">Supportivo</option>
                    <option value="professional">Professionale</option>
                    <option value="motivational">Motivazionale</option>
                </select>
            </div>

            <div class="setting-group">
                <label>üìö Stile di Apprendimento</label>
                <select id="learningStyle">
                    <option value="visual">Visuale (diagrammi, mappe)</option>
                    <option value="auditory">Uditivo (spiegazioni verbali)</option>
                    <option value="kinesthetic">Cinestetico (esempi pratici)</option>
                    <option value="reading">Lettura/Scrittura</option>
                    <option value="adaptive">Adattivo (misto)</option>
                </select>
            </div>

            <div class="setting-group">
                <label>üí™ Materie Forti</label>
                <div class="subject-tags">
                    <div class="subject-tag" data-subject="matematica">Matematica</div>
                    <div class="subject-tag" data-subject="informatica">Informatica</div>
                    <div class="subject-tag" data-subject="italiano">Italiano</div>
                    <div class="subject-tag" data-subject="inglese">Inglese</div>
                    <div class="subject-tag" data-subject="fisica">Fisica</div>
                    <div class="subject-tag" data-subject="storia">Storia</div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeAISettings()">Annulla</button>
            <button class="save-settings-btn" onclick="saveAISettings()">Salva Impostazioni</button>
        </div>
    </div>
</div>

<!-- AI DASHBOARD MODAL -->
<div id="aiDashboardModal" class="modal-overlay" style="display: none;">
    <div class="ai-dashboard-container">
        <div class="modal-header">
            <h3><i class="fas fa-chart-line"></i> Dashboard Apprendimento</h3>
            <button class="close-btn" onclick="closeAIDashboard()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="ai-dashboard-content" id="aiDashboardContent">
            <div class="loading">
                <div class="spinner"></div>
                Caricamento dashboard...
            </div>
        </div>
    </div>
</div>

<style>
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(5px);
}

.ai-chat-container, .ai-settings-container, .ai-dashboard-container {
    background: white;
    border-radius: 15px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
}

.ai-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.ai-info {
    display: flex;
    align-items: center;
    gap: 0.8rem;
}

.ai-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    border: 2px solid rgba(255,255,255,0.3);
}

.close-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 0.5rem;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
}

.close-btn:hover {
    background: rgba(255,255,255,0.3);
    transform: scale(1.1);
}

.ai-chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    max-height: 400px;
    background: #f8f9fa;
}

.ai-message {
    background: white;
    margin-bottom: 1rem;
    padding: 1rem;
    border-radius: 12px;
    border-left: 4px solid #667eea;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    animation: slideInLeft 0.3s ease;
}

.user-message {
    background: #667eea;
    color: white;
    text-align: right;
    border-left: none;
    border-right: 4px solid #764ba2;
    margin-left: 2rem;
    animation: slideInRight 0.3s ease;
}

.ai-input-container {
    border-top: 1px solid #e9ecef;
    padding: 1rem;
    background: white;
}

.ai-chat-form {
    margin-bottom: 1rem;
}

.ai-input-wrapper {
    display: flex;
    gap: 0.5rem;
    background: #f8f9fa;
    border-radius: 25px;
    padding: 0.3rem;
    border: 2px solid #e9ecef;
    transition: border-color 0.3s ease;
}

.ai-input-wrapper:focus-within {
    border-color: #667eea;
    box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
}

.ai-input-wrapper input {
    flex: 1;
    padding: 0.8rem 1rem;
    border: none;
    background: none;
    outline: none;
    font-size: 1rem;
}

.ai-send-btn {
    background: #667eea;
    color: white;
    border: none;
    padding: 0.8rem 1rem;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.ai-send-btn:hover {
    background: #764ba2;
    transform: scale(1.1);
}

.ai-quick-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.quick-action-btn {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.3s ease;
}

.quick-action-btn:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
}

.ai-settings-content, .ai-dashboard-content {
    padding: 1.5rem;
    overflow-y: auto;
    max-height: 70vh;
}

.setting-group {
    margin-bottom: 1.5rem;
}

.setting-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #333;
}

.setting-group input, .setting-group select {
    width: 100%;
    padding: 0.8rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.setting-group input:focus, .setting-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
}

.avatar-selector {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.avatar-option {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    padding: 0.8rem;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.5rem;
    transition: all 0.3s ease;
}

.avatar-option:hover, .avatar-option.active {
    border-color: #667eea;
    background: #667eea;
    transform: scale(1.1);
}

.subject-tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.subject-tag {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.subject-tag:hover, .subject-tag.active {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.save-settings-btn {
    width: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 1rem;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.save-settings-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
}

.typing-indicator {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    padding: 1rem;
    background: white;
    border-radius: 12px;
    border-left: 4px solid #667eea;
    margin-bottom: 1rem;
}

.typing-indicator span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #667eea;
    animation: typing 1.4s ease-in-out infinite;
}

.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
    0%, 60%, 100% { transform: scale(1); opacity: 0.5; }
    30% { transform: scale(1.2); opacity: 1; }
}

@keyframes slideInLeft {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
}

@keyframes slideInRight {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
}

.loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    padding: 2rem;
    color: #667eea;
    font-weight: 600;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
// AI Chatbot Global Variables
let aiProfile = null;
let aiConversationHistory = [];
let selectedAvatar = 'ü§ñ';
let strongSubjects = [];
let weakSubjects = [];

// Modal Functions
function openAIAssistant() {
    document.getElementById('aiAssistantModal').style.display = 'flex';
    loadAIProfile();
}

function closeAIAssistant() {
    document.getElementById('aiAssistantModal').style.display = 'none';
}

function openAISettings() {
    document.getElementById('aiSettingsModal').style.display = 'flex';
    loadAIProfile();
}

function closeAISettings() {
    document.getElementById('aiSettingsModal').style.display = 'none';
}

function openAIDashboard() {
    document.getElementById('aiDashboardModal').style.display = 'flex';
    loadAIDashboard();
}

function closeAIDashboard() {
    document.getElementById('aiDashboardModal').style.display = 'none';
}

// Load AI Profile
async function loadAIProfile() {
    try {
        const response = await fetch('/api/ai/profile');
        if (!response.ok) {
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            throw new Error(`HTTP ${response.status}`);
        }

        const profile = await response.json();
        aiProfile = profile;

        // Update UI elements
        document.getElementById('aiBotName').textContent = profile.bot_name;
        document.getElementById('aiAvatar').textContent = profile.bot_avatar;

        // Update settings form if open
        if (document.getElementById('botNameInput')) {
            document.getElementById('botNameInput').value = profile.bot_name;
            document.getElementById('conversationStyle').value = profile.conversation_tone || 'friendly';
            document.getElementById('learningStyle').value = profile.learning_style || 'adaptive';

            selectedAvatar = profile.bot_avatar;
            updateAvatarSelection();

            strongSubjects = profile.strong_subjects || [];
            updateSubjectTags();
        }

        console.log('‚úÖ AI Profile loaded:', profile.bot_name);
    } catch (error) {
        console.error('‚ùå Error loading AI profile:', error);
        showNotification('Errore', 'Impossibile caricare il profilo AI', 'error');
    }
}

// Avatar Selection
function selectAvatar(emoji) {
    selectedAvatar = emoji;
    updateAvatarSelection();
    document.getElementById('aiAvatar').textContent = emoji;
}

function updateAvatarSelection() {
    document.querySelectorAll('.avatar-option').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent === selectedAvatar) {
            btn.classList.add('active');
        }
    });
}

// Subject Tags Management
function updateSubjectTags() {
    document.querySelectorAll('.subject-tag').forEach(tag => {
        const subject = tag.dataset.subject;
        tag.classList.toggle('active', strongSubjects.includes(subject));

        tag.onclick = () => {
            if (strongSubjects.includes(subject)) {
                strongSubjects = strongSubjects.filter(s => s !== subject);
                tag.classList.remove('active');
            } else {
                strongSubjects.push(subject);
                tag.classList.add('active');
            }
        };
    });
}

// Save AI Settings
async function saveAISettings() {
    try {
        const settingsData = {
            bot_name: document.getElementById('botNameInput').value || 'SKAILA Assistant',
            bot_avatar: selectedAvatar,
            conversation_tone: document.getElementById('conversationStyle').value,
            learning_style: document.getElementById('learningStyle').value,
            strong_subjects: strongSubjects,
            weak_subjects: weakSubjects
        };

        const response = await fetch('/api/ai/profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settingsData)
        });

        if (response.ok) {
            showNotification('Successo', 'Impostazioni AI salvate con successo!', 'success');
            closeAISettings();
            loadAIProfile();
        } else {
            throw new Error('Errore salvataggio');
        }
    } catch (error) {
        console.error('‚ùå Error saving AI settings:', error);
        showNotification('Errore', 'Impossibile salvare le impostazioni', 'error');
    }
}

// Send Quick Message
function sendQuickMessage(message) {
    document.getElementById('aiMessageInput').value = message;
    document.getElementById('aiChatForm').dispatchEvent(new Event('submit'));
}

// Add AI Message to Chat
function addAIMessage(content, sender, avatar = 'ü§ñ') {
    const messagesContainer = document.getElementById('aiChatMessages');

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender === 'user' ? 'user-message' : 'ai-message'}`;

    if (sender === 'ai') {
        messageDiv.innerHTML = `
            <div class="message-content">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.2rem;">${avatar}</span>
                    <strong>${aiProfile?.bot_name || 'SKAILA Assistant'}</strong>
                </div>
                <div>${content}</div>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="message-content">
                <div>${content}</div>
            </div>
        `;
    }

    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Show/Hide Typing Indicator
function showAITyping() {
    const messagesContainer = document.getElementById('aiChatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typingIndicator';
    typingDiv.className = 'typing-indicator';
    typingDiv.innerHTML = `
        <span></span>
        <span></span>
        <span></span>
        <span style="margin-left: 0.5rem;">Il tuo AI sta pensando...</span>
    `;
    messagesContainer.appendChild(typingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideAITyping() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// AI Chat Form Handler
document.getElementById('aiChatForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const input = document.getElementById('aiMessageInput');
    const message = input.value.trim();

    if (!message) return;

    // Add user message to chat
    addAIMessage(message, 'user');
    input.value = '';

    // Show typing indicator
    showAITyping();

    try {
        const response = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: message })
        });

        const data = await response.json();

        if (response.ok) {
            hideAITyping();
            addAIMessage(data.response, 'ai', data.bot_avatar);

            // Store conversation history
            aiConversationHistory.push({
                user: message,
                ai: data.response,
                timestamp: new Date()
            });
        } else {
            throw new Error(data.error || 'Errore AI');
        }
    } catch (error) {
        hideAITyping();
        addAIMessage('Mi dispiace, c\'√® stato un errore. Riprova tra poco! üòÖ', 'ai');
        console.error('‚ùå AI Chat Error:', error);
    }
});

// Load AI Dashboard
async function loadAIDashboard() {
    const dashboardContent = document.getElementById('aiDashboardContent');

    try {
        const response = await fetch('/api/ai/dashboard');
        if (!response.ok) throw new Error('Errore caricamento dashboard');

        const data = await response.json();

        dashboardContent.innerHTML = `
            <div class="dashboard-grid">
                <div class="stat-card">
                    <h4>üìä Progresso Generale</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${data.progress_metrics.overall_progress}%"></div>
                    </div>
                    <p>${data.progress_metrics.overall_progress}%</p>
                </div>

                <div class="stat-card">
                    <h4>üí¨ Interazioni Totali</h4>
                    <p class="big-number">${data.progress_metrics.total_interactions}</p>
                </div>

                <div class="stat-card">
                    <h4>üî• Streak Settimanale</h4>
                    <p class="big-number">${data.progress_metrics.weekly_activity} giorni</p>
                </div>

                <div class="achievement-section">
                    <h4>üèÜ Achievement</h4>
                    ${data.achievements.map(achievement => `
                        <div class="achievement ${achievement.unlocked ? 'unlocked' : 'locked'}">
                            <span class="achievement-icon">${achievement.unlocked ? '‚úÖ' : 'üîí'}</span>
                            <div>
                                <strong>${achievement.name}</strong>
                                <p>${achievement.description}</p>
                                <div class="progress-bar small">
                                    <div class="progress-fill" style="width: ${achievement.progress}%"></div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="recommendations-section">
                    <h4>üí° Raccomandazioni</h4>
                    ${(data.recommendations || []).map(rec => `
                        <div class="recommendation">${rec}</div>
                    `).join('')}
                </div>
            </div>
        `;

        // Add dashboard styles
        if (!document.querySelector('#dashboardStyles')) {
            const dashboardStyles = document.createElement('style');
            dashboardStyles.id = 'dashboardStyles';
            dashboardStyles.textContent = `
                .dashboard-grid { display: grid; gap: 1rem; }
                .stat-card { background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #667eea; }
                .big-number { font-size: 2rem; font-weight: bold; color: #667eea; margin: 0; }
                .progress-bar { background: #e9ecef; height: 10px; border-radius: 5px; overflow: hidden; margin: 0.5rem 0; }
                .progress-bar.small { height: 6px; }
                .progress-fill { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; transition: width 0.3s ease; }
                .achievement { display: flex; align-items: center; gap: 0.8rem; padding: 0.8rem; margin: 0.5rem 0; border-radius: 8px; background: #f8f9fa; }
                .achievement.unlocked { background: #d4edda; border-left: 4px solid #28a745; }
                .achievement.locked { background: #f8d7da; border-left: 4px solid #dc3545; opacity: 0.7; }
                .recommendation { background: #fff3cd; padding: 0.8rem; margin: 0.5rem 0; border-radius: 8px; border-left: 3px solid #ffc107; }
            `;
            document.head.appendChild(dashboardStyles);
        }

    } catch (error) {
        dashboardContent.innerHTML = '<div class="error">Errore caricamento dashboard AI</div>';
        console.error('‚ùå Dashboard Error:', error);
    }
}

// Initialize AI Chat on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAIProfile();

    // Add click handlers for AI buttons in chat sidebar
    const aiSettingsBtn = document.querySelector('.action-btn[onclick="openAISettings()"]');
    if (aiSettingsBtn) {
        aiSettingsBtn.addEventListener('click', openAISettings);
    }
});

// Close modals when clicking outside
document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });
});

console.log('‚úÖ AI Chatbot System initialized');
</script>